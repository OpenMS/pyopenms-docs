name: Linting code-blocks
on: [pull_request]
jobs:
  linting:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-python@v4
      with:
        python-version: '3.10' # Version range or exact version of a Python version to use, using SemVer's version range syntax

    - name: Installing Dependencies
      run: |
        pip install blacken-docs
        npm i diff-so-fancy

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        dir_names_max_depth: 0
        files: |
          docs/source/*.rst
          docs/source/**/*.rst
          !docs/source/**/_templates

    - name: Running blacken
      run: |
        blacken-docs -E -l 80 ${{ steps.changed-files.outputs.all_changed_files }} > blacken.log | true
        cat blacken.log
        if grep -q "parse error" "blacken.log"; then
           exit 1
        fi

    - name: Display diff
      run: |
        git config --global core.pager "diff-so-fancy | less --tabs=4 -RFX"
        git config --global interactive.diffFilter "diff-so-fancy --patch"
        git config --global color.ui true

        git config --global color.diff-highlight.oldNormal    "red bold"
        git config --global color.diff-highlight.oldHighlight "red bold 52"
        git config --global color.diff-highlight.newNormal    "green bold"
        git config --global color.diff-highlight.newHighlight "green bold 22"

        git config --global color.diff.meta       "11"
        git config --global color.diff.frag       "magenta bold"
        git config --global color.diff.func       "146 bold"
        git config --global color.diff.commit     "yellow bold"
        git config --global color.diff.old        "red bold"
        git config --global color.diff.new        "green bold"
        git config --global color.diff.whitespace "red reverse"
        git diff
